<div
  class="add-task-container"
  [class.isElevated]="isElevated()"
  @blendInOut
>
  <div class="input-section">
    <input
      #inputEl
      class="task-input"
      [formControl]="titleControl"
      [tabindex]="tabindex()"
      [mention]="tagMentions | async"
      [mentionConfig]="mentionCfg$ | async"
      (opened)="isMentionMenuOpen.set(true)"
      (closed)="onMentionClosed()"
      [matAutocomplete]="taskAutoCompleteEl"
      [placeholder]="
        isSearchMode() ? 'Add existing task or issues...' : 'A task title #tag @16:00'
      "
      matInput
      spellcheck="false"
      (keydown)="onInputKeydown($event)"
      (blur)="onBlur()"
    />

    <div class="right-button-controls">
      @if (titleControl.value?.trim()) {
        <div class="separator-box">
          <button
            mat-icon-button
            class="switch-add-to-btn"
            (click)="addTask()"
            type="submit"
            [matTooltip]="'Add task'"
            matTooltipPosition="above"
          >
            <mat-icon>add</mat-icon>
          </button>
        </div>
      }

      <button
        mat-icon-button
        class="switch-add-to-bot-btn"
        (click)="toggleIsAddToBottom()"
        [matTooltip]="isAddToBottom() ? 'Add to top (Ctrl+1)' : 'Add to bottom (Ctrl+1)'"
        matTooltipPosition="above"
      >
        <mat-icon
          >{{ isAddToBottom() ? 'vertical_align_bottom' : 'vertical_align_top' }}
        </mat-icon>
      </button>

      @if (stateService.state().project?.isEnableBacklog) {
        <button
          mat-icon-button
          class="switch-add-to-btn"
          (click)="toggleIsAddToBacklog()"
          [matTooltip]="isAddToBacklog() ? 'Add to today' : 'Add to backlog'"
          matTooltipPosition="above"
        >
          <mat-icon>{{ isAddToBacklog() ? 'inbox' : 'today' }}</mat-icon>
        </button>
      }

      <button
        mat-icon-button
        class="search-toggle-btn"
        [class.active]="isSearchMode()"
        (click)="toggleSearchMode()"
        [matTooltip]="
          isSearchMode()
            ? 'Disable issue search (Ctrl+2)'
            : 'Enable issue search (Ctrl+2)'
        "
        matTooltipPosition="above"
      >
        <mat-icon>search</mat-icon>
      </button>
    </div>
  </div>

  @if (isSearchMode()) {
    @if (activatedIssueTask() && activatedIssueTask()!.issueType === undefined) {
      <div class="add-issue-info-text bold">
        <mat-icon>playlist_add</mat-icon>
        {{
          T.F.TASK.ADD_TASK_BAR.ADD_EXISTING_TASK
            | translate: { taskTitle: activatedIssueTask()!.title }
        }}
      </div>
    } @else {
      <div class="add-issue-info-text">
        <mat-icon>playlist_add</mat-icon>
        Search and add issues and tasks from archive and other projects
      </div>
    }
  } @else {
    <add-task-bar-actions></add-task-bar-actions>
  }
</div>

<mat-autocomplete
  #taskAutoCompleteEl="matAutocomplete"
  class="add-task-bar-panel"
  (optionActivated)="onTaskSuggestionActivated($event?.option?.value)"
  (optionSelected)="onTaskSuggestionSelected($event.option.value)"
  [autoActiveFirstOption]="true"
>
  @for (
    item of suggestions$ | async;
    track item.taskId || (item.issueData && item.issueData.id)
  ) {
    <mat-option [value]="item">
      @if (item.issueType) {
        <mat-icon [svgIcon]="item.issueType | issueIcon"></mat-icon>
      } @else if (item.taskId && item.isArchivedTask) {
        <mat-icon>archive</mat-icon>
      } @else if (item.taskId) {
        <mat-icon>task</mat-icon>
      } @else if (!item.ctx) {
        <mat-icon>library_books</mat-icon>
      }
      @if (item.ctx) {
        <tag
          [tag]="item.ctx"
          [isHideTitle]="isHideTagTitles()"
        ></tag>
      }
      <span [innerHTML]="item?.titleHighlighted || item?.title"></span>
      @if (item.taskId && item.projectId) {
        @for (project of projects$ | async; track project.id) {
          @if (project.id === item.projectId) {
            <mat-icon
              class="project-icon"
              [style.color]="project.theme.primary"
            >
              {{ project.icon || 'folder' }}
            </mat-icon>
            <span class="project-title">{{ project.title }}</span>
          }
        }
      }
    </mat-option>
  }
</mat-autocomplete>

@if (isSearchLoading()) {
  <div class="spinner">
    <mat-spinner diameter="24"></mat-spinner>
  </div>
}
