<div
  class="add-mode-container"
  [class.isElevated]="isElevated()"
  @blendInOut
>
  <div class="input-section">
    <input
      #inputEl
      class="task-input"
      [formControl]="titleControl"
      [tabindex]="tabindex()"
      [mention]="tagMentions | async"
      [mentionConfig]="tagMentionConfig | async"
      [matAutocomplete]="taskAutoEl"
      [placeholder]="
        isSearchMode()
          ? 'Add existing task or issues...'
          : 'Add a task... +project #tag @16:00'
      "
      matInput
      spellcheck="false"
      (keydown.enter)="handleEnterKey($event)"
      (keydown)="onInputKeydown($event)"
      (blur)="onBlur()"
    />

    <div class="button-controls">
      @if (titleControl.value?.trim()) {
        <div class="separator-box">
          <button
            mat-icon-button
            class="switch-add-to-btn"
            (click)="addTask()"
            type="submit"
            [matTooltip]="'Add task'"
            matTooltipPosition="above"
          >
            <mat-icon>add</mat-icon>
          </button>
        </div>
      }

      <button
        mat-icon-button
        class="switch-add-to-bot-btn"
        (click)="toggleIsAddToBottom()"
        [matTooltip]="isAddToBottom() ? 'Add to top (Ctrl+1)' : 'Add to bottom (Ctrl+1)'"
        matTooltipPosition="above"
      >
        <mat-icon
          >{{ isAddToBottom() ? 'vertical_align_bottom' : 'vertical_align_top' }}
        </mat-icon>
      </button>

      @if (state().project?.isEnableBacklog) {
        <button
          mat-icon-button
          class="switch-add-to-btn"
          (click)="toggleIsAddToBacklog()"
          [matTooltip]="isAddToBacklog() ? 'Add to today' : 'Add to backlog'"
          matTooltipPosition="above"
        >
          <mat-icon>{{ isAddToBacklog() ? 'inbox' : 'today' }}</mat-icon>
        </button>
      }

      <button
        mat-icon-button
        class="search-toggle-btn"
        [class.active]="isSearchMode()"
        (click)="toggleSearchMode()"
        [matTooltip]="
          isSearchMode()
            ? 'Disable issue search (Ctrl+2)'
            : 'Enable issue search (Ctrl+2)'
        "
        matTooltipPosition="above"
      >
        <mat-icon>search</mat-icon>
      </button>
    </div>
  </div>

  <mat-autocomplete
    #taskAutoEl="matAutocomplete"
    class="add-task-bar-panel"
    (optionActivated)="onTaskSuggestionActivated($event?.option?.value)"
    (optionSelected)="onTaskSuggestionSelected($event.option.value)"
    [autoActiveFirstOption]="true"
  >
    @for (
      item of suggestions$ | async;
      track item.taskId || (item.issueData && item.issueData.id)
    ) {
      <mat-option [value]="item">
        @if (item.issueType) {
          <mat-icon [svgIcon]="item.issueType | issueIcon"></mat-icon>
        } @else if (item.taskId && item.isArchivedTask) {
          <mat-icon>archive</mat-icon>
        } @else if (item.taskId) {
          <mat-icon>task</mat-icon>
        } @else if (!item.ctx) {
          <mat-icon>library_books</mat-icon>
        }
        @if (item.ctx) {
          <tag
            [tag]="item.ctx"
            [isHideTitle]="isHideTagTitles()"
          ></tag>
        }
        <span [innerHTML]="item?.titleHighlighted || item?.title"></span>
        @if (item.taskId && item.projectId) {
          @for (project of projects$ | async; track project.id) {
            @if (project.id === item.projectId) {
              <mat-icon
                class="project-icon"
                [style.color]="project.theme.primary"
              >
                {{ project.icon || 'folder' }}
              </mat-icon>
              <span class="project-title">{{ project.title }}</span>
            }
          }
        }
      </mat-option>
    }
  </mat-autocomplete>

  @if (activatedIssueTask() && activatedIssueTask()!.issueType === undefined) {
    <div class="add-issue-info-text">
      <mat-icon>playlist_add</mat-icon>
      {{
        T.F.TASK.ADD_TASK_BAR.ADD_EXISTING_TASK
          | translate: { taskTitle: activatedIssueTask()!.title }
      }}
    </div>
  } @else {
    <div class="bottom-section">
      <button
        #projectMenuTrigger
        mat-button
        class="action-btn project-btn"
        [matMenuTriggerFor]="projectMenu"
        [class.has-value]="state().project"
        [class.auto-detected]="isAutoDetected() && !!state().project"
        [class.menu-open]="isProjectMenuOpen()"
        (click)="onProjectMenuClick($event)"
      >
        <mat-icon [style.color]="state().project!.theme.primary"
          >{{ state().project!.icon || 'folder' }}
        </mat-icon>
        <span>{{ state().project?.title }}</span>
      </button>

      <button
        mat-button
        class="action-btn date-btn"
        (click)="openScheduleDialog()"
        [class.has-value]="state().date"
      >
        <mat-icon>{{ state().time ? 'schedule' : 'event' }}</mat-icon>
        <span>{{ dateDisplay() || 'Due' }}</span>
      </button>

      @if (state().date) {
        <button
          mat-button
          class="clear-btn"
          (click)="clearDate(); $event.stopPropagation()"
          [matTooltip]="'Clear date'"
          matTooltipPosition="above"
        >
          <mat-icon>close</mat-icon>
        </button>
      }

      <button
        #tagsMenuTrigger
        mat-button
        class="action-btn tags-btn"
        [matMenuTriggerFor]="tagsMenu"
        [class.has-value]="state().tags.length > 0 || hasNewTags()"
        [class.has-new-tags]="hasNewTags()"
        [class.menu-open]="isTagsMenuOpen()"
        (click)="onTagsMenuClick($event)"
      >
        @if (state().tags.length === 0 && state().newTagTitles.length === 0) {
          <ng-container>
            <mat-icon>label</mat-icon>
            Tags
          </ng-container>
        } @else {
          <div class="tags-display">
            @for (tag of state().tags; track tag.id) {
              <div class="tag-item">
                <mat-icon [style.color]="tag.color || tag.theme?.primary">
                  {{ tag.icon || 'label' }}
                </mat-icon>
                <span class="tag-title">{{ tag.title }}</span>
              </div>
            }
            @for (newTag of state().newTagTitles; track newTag) {
              <div class="tag-item new-tag">
                <mat-icon>new_releases</mat-icon>
                <span class="tag-title">{{ newTag }}</span>
              </div>
            }
          </div>
        }
      </button>

      @if (state().tags.length > 0 || hasNewTags()) {
        <button
          mat-button
          class="clear-btn"
          (click)="clearTags(); $event.stopPropagation()"
          [matTooltip]="'Clear tags'"
          matTooltipPosition="above"
        >
          <mat-icon>close</mat-icon>
        </button>
      }

      <button
        #estimateMenuTrigger
        mat-button
        class="action-btn estimate-btn"
        [matMenuTriggerFor]="estimateMenu"
        [class.has-value]="state().estimate"
        [class.menu-open]="isEstimateMenuOpen()"
        (click)="onEstimateMenuClick($event)"
      >
        <mat-icon>timer</mat-icon>
        <span>{{ estimateDisplay() || 'Estimate' }}</span>
      </button>

      @if (state().estimate) {
        <button
          mat-button
          class="clear-btn"
          (click)="clearEstimate(); $event.stopPropagation()"
          [matTooltip]="'Clear estimate'"
          matTooltipPosition="above"
        >
          <mat-icon>close</mat-icon>
        </button>
      }
    </div>
  }
</div>

@if (isSearchLoading()) {
  <div class="spinner">
    <mat-spinner diameter="24"></mat-spinner>
  </div>
}

<!-------------- Menus ------------------->
<mat-menu #projectMenu="matMenu">
  @for (project of projects$ | async; track project.id) {
    <button
      mat-menu-item
      (click)="onProjectSelect(project)"
    >
      <mat-icon [style.color]="project.theme.primary"
        >{{ project.icon || 'folder' }}
      </mat-icon>
      {{ project.title }}
    </button>
  }
</mat-menu>

<mat-menu #tagsMenu="matMenu">
  @for (tag of tags$ | async; track tag.id) {
    <button
      mat-menu-item
      (click)="onTagToggle(tag)"
      [class.selected]="hasSelectedTag(tag.id)"
    >
      <mat-icon [style.color]="tag.color || tag.theme?.primary">
        {{ hasSelectedTag(tag.id) ? 'check_box' : 'check_box_outline_blank' }}
      </mat-icon>
      {{ tag.title }}
    </button>
  }
</mat-menu>

<mat-menu #dateMenu="matMenu">
  @for (option of DATE_OPTIONS; track option.label) {
    <button
      mat-menu-item
      (click)="onDateSelect(option.getDate())"
    >
      <mat-icon>{{ option.icon }}</mat-icon>
      {{ option.label }}
    </button>
  }
  <button
    mat-menu-item
    (click)="onDateSelect(null)"
  >
    <mat-icon>clear</mat-icon>
    No Date
  </button>
</mat-menu>

<mat-menu #timeMenu="matMenu">
  @for (time of TIME_OPTIONS; track time) {
    <button
      mat-menu-item
      (click)="onTimeSelect(time)"
    >
      {{ time }}
    </button>
  }
  <button
    mat-menu-item
    (click)="onTimeSelect(null)"
  >
    <mat-icon>clear</mat-icon>
    No Time
  </button>
</mat-menu>

<mat-menu #estimateMenu="matMenu">
  @for (option of ESTIMATE_OPTIONS; track option.value) {
    <button
      mat-menu-item
      (click)="onEstimateInput(option.value)"
    >
      {{ option.label }}
    </button>
  }
</mat-menu>
