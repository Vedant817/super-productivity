<div
  class="add-mode-container"
  [class.isElevated]="isElevated()"
>
  <div class="input-section">
    <input
      #inputEl
      class="task-input"
      [formControl]="titleControl"
      [tabindex]="tabindex()"
      [mention]="tagMentions | async"
      [mentionConfig]="tagMentionConfig | async"
      placeholder="Add a task... (+project #tag @16:00)"
      matInput
      spellcheck="false"
      (keydown.enter)="$event.preventDefault(); addTask()"
      (keydown)="onInputKeydown($event)"
    />

    <div class="button-controls">
      @if (titleControl.value?.trim()) {
        <div class="separator-box">
          <button
            mat-icon-button
            class="switch-add-to-btn"
            (click)="addTask()"
            type="submit"
            [matTooltip]="'Add task'"
            matTooltipPosition="above"
          >
            <mat-icon>add</mat-icon>
          </button>
        </div>
      }

      <button
        mat-icon-button
        class="switch-add-to-bot-btn"
        (click)="toggleIsAddToBottom()"
        [matTooltip]="
          localIsAddToBottom() ? 'Add to top (Ctrl+1)' : 'Add to bottom (Ctrl+1)'
        "
        matTooltipPosition="above"
      >
        <mat-icon
          >{{ localIsAddToBottom() ? 'vertical_align_bottom' : 'vertical_align_top' }}
        </mat-icon>
      </button>

      @if (selectedProject()?.isEnableBacklog) {
        <button
          mat-icon-button
          class="switch-add-to-btn"
          (click)="toggleIsAddToBacklog()"
          [matTooltip]="localIsAddToBacklog() ? 'Add to today' : 'Add to backlog'"
          matTooltipPosition="above"
        >
          <mat-icon>{{ localIsAddToBacklog() ? 'inbox' : 'today' }}</mat-icon>
        </button>
      }

      <button
        mat-icon-button
        class="search-toggle-btn"
        (click)="switchToSearchMode.emit()"
        [matTooltip]="'Search for issues (Ctrl+2)'"
        matTooltipPosition="above"
      >
        <mat-icon>search</mat-icon>
      </button>
    </div>
  </div>

  <div class="action-buttons">
    <button
      #projectMenuTrigger
      mat-button
      class="action-btn project-btn"
      [matMenuTriggerFor]="projectMenu"
      [class.has-value]="selectedProject()"
      [class.auto-detected]="isProjectAutoDetected()"
      [class.menu-open]="isProjectMenuOpen()"
      (click)="onProjectMenuClick($event)"
    >
      <mat-icon [style.color]="selectedProject()!.theme.primary"
        >{{ selectedProject()!.icon || 'folder' }}
      </mat-icon>
      <span>{{ selectedProject()?.title }}</span>
    </button>

    <button
      #tagsMenuTrigger
      mat-button
      class="action-btn tags-btn"
      [matMenuTriggerFor]="tagsMenu"
      [class.has-value]="selectedTags().length > 0 || hasNewTags()"
      [class.has-new-tags]="hasNewTags()"
      [class.menu-open]="isTagsMenuOpen()"
      (click)="onTagsMenuClick($event)"
    >
      @if (selectedTags().length === 0 && newTagTitles().length === 0) {
        <mat-icon>label</mat-icon>
        Tags
      } @else {
        <div class="tags-display">
          @for (tag of selectedTags(); track tag.id) {
            <div class="tag-item">
              <mat-icon [style.color]="tag.color || tag.theme?.primary">
                {{ tag.icon || 'label' }}
              </mat-icon>
              <span class="tag-title">{{ tag.title }}</span>
            </div>
          }
          @for (newTag of newTagTitles(); track newTag) {
            <div class="tag-item new-tag">
              <mat-icon>new_releases</mat-icon>
              <span class="tag-title">{{ newTag }}</span>
            </div>
          }
        </div>
      }
    </button>

    @if (selectedTags().length > 0 || hasNewTags()) {
      <button
        mat-button
        class="clear-btn"
        (click)="clearTags(); $event.stopPropagation()"
        [matTooltip]="'Clear tags'"
        matTooltipPosition="above"
      >
        <mat-icon>close</mat-icon>
      </button>
    }

    <button
      mat-button
      class="action-btn date-btn"
      (click)="openScheduleDialog()"
      [class.has-value]="selectedDate()"
    >
      <mat-icon>{{ selectedTime() ? 'schedule' : 'event' }}</mat-icon>
      <span>{{ dateDisplay() || 'Due' }}</span>
    </button>

    @if (selectedDate()) {
      <button
        mat-button
        class="clear-btn"
        (click)="clearDate(); $event.stopPropagation()"
        [matTooltip]="'Clear date'"
        matTooltipPosition="above"
      >
        <mat-icon>close</mat-icon>
      </button>
    }

    <button
      #estimateMenuTrigger
      mat-button
      class="action-btn estimate-btn"
      [matMenuTriggerFor]="estimateMenu"
      [class.has-value]="selectedEstimate()"
      [class.menu-open]="isEstimateMenuOpen()"
      (click)="onEstimateMenuClick($event)"
    >
      <mat-icon>timer</mat-icon>
      <span>{{ estimateDisplay() || 'Estimate' }}</span>
    </button>

    @if (selectedEstimate()) {
      <button
        mat-button
        class="clear-btn"
        (click)="clearEstimate(); $event.stopPropagation()"
        [matTooltip]="'Clear estimate'"
        matTooltipPosition="above"
      >
        <mat-icon>close</mat-icon>
      </button>
    }
  </div>
</div>

<mat-menu #projectMenu="matMenu">
  @for (project of projects$ | async; track project.id) {
    <button
      mat-menu-item
      (click)="onProjectSelect(project)"
    >
      <mat-icon [style.color]="project.theme.primary"
        >{{ project.icon || 'folder' }}
      </mat-icon>
      {{ project.title }}
    </button>
  }
</mat-menu>

<mat-menu #tagsMenu="matMenu">
  @for (tag of tags$ | async; track tag.id) {
    <button
      mat-menu-item
      (click)="onTagToggle(tag)"
      [class.selected]="hasSelectedTag(tag.id)"
    >
      <mat-icon [style.color]="tag.color || tag.theme?.primary">
        {{ hasSelectedTag(tag.id) ? 'check_box' : 'check_box_outline_blank' }}
      </mat-icon>
      {{ tag.title }}
    </button>
  }
</mat-menu>

<mat-menu #dateMenu="matMenu">
  @for (option of DATE_OPTIONS; track option.label) {
    <button
      mat-menu-item
      (click)="onDateSelect(option.getDate())"
    >
      <mat-icon>{{ option.icon }}</mat-icon>
      {{ option.label }}
    </button>
  }
  <button
    mat-menu-item
    (click)="onDateSelect(null)"
  >
    <mat-icon>clear</mat-icon>
    No Date
  </button>
</mat-menu>

<mat-menu #timeMenu="matMenu">
  @for (time of TIME_OPTIONS; track time) {
    <button
      mat-menu-item
      (click)="onTimeSelect(time)"
    >
      {{ time }}
    </button>
  }
  <button
    mat-menu-item
    (click)="onTimeSelect(null)"
  >
    <mat-icon>clear</mat-icon>
    No Time
  </button>
</mat-menu>

<mat-menu #estimateMenu="matMenu">
  @for (option of ESTIMATE_OPTIONS; track option.value) {
    <button
      mat-menu-item
      (click)="onEstimateInput(option.value)"
    >
      {{ option.label }}
    </button>
  }
</mat-menu>
